version: '3.8'

services:
  mailserver:
    image: analogic/poste.io
    container_name: mailserver
    hostname: ${POSTEO_HOST_NAME}
    environment:
      - TZ=${TZ}
      - POSTEO_DOMAIN=${POSTEO_DOMAIN}
      - POSTEO_ADMIN_PASSWORD=${POSTEO_ADMIN_PASSWORD}
      - POSTEO_POSTMASTER_PASSWORD=${POSTEO_POSTMASTER_PASSWORD}
      - POSTEO_SMTP_PORT=25
      - POSTEO_IMAP_PORT=143
      - POSTEO_WEBSERVER_PORT=80
      - POSTEO_HTTP_PORT=80
    volumes:
    - ./data:/data
    - ./mail:/mail
    - ./certs:/etc/ssl/certs  # Add this for SSL certificates
    ports:
      - "25:25"      # SMTP
      - "143:143"    # IMAP
      - "88:80"      # Web interface (non-SSL)
      - "8443:443"    # Web interface (SSL, optional)
    restart: unless-stopped
    
  backup:
    image: amazon/aws-cli:2.13.17
    container_name: mailserver_backup
    depends_on:
      - mailserver
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION}
      S3_BUCKET: ${S3_BUCKET}
    volumes:
      - ./data:/data
      - ./mail:/mail
    entrypoint: >
      /bin/sh -c "
      while true; do
        TIMESTAMP=$(date +%Y%m%d-%H%M%S);
        BACKUP_FILE=/tmp/posteio-backup-$TIMESTAMP.tar.gz;
        tar -czvf $BACKUP_FILE /data /mail;
        aws s3 cp $BACKUP_FILE s3://$S3_BUCKET/$TIMESTAMP.tar.gz;
        rm -f $BACKUP_FILE;
        sleep 86400; # Run backup every 24 hours
      done"
